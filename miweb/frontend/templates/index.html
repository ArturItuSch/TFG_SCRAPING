{% extends 'base.html' %}
{% load static %}
{% load static custom_filters %}
{% block extra_css %}{% endblock %}
{% block title %}Partidos - LEC{% endblock %}

{% block content %}
<div class="container mt-5 text-white">

  <!-- FILA 1 -->
  <div class="row g-4 mb-5">
    <!-- Últimas Series -->
    <div class="col-12 col-md-6">
      <h2>Últimas Series - {{ ultimo_split.year }} {{ ultimo_split.split_type|capfirst }}</h2>
      <div id="series-container" class="border border-primary rounded bg-light overflow-auto" style="max-height: 600px;">
        {% for serie in ultimas_series %}
        {% with resultados=resultados_por_serie|dictget:serie.id %}
        <div class="card bg-dark text-white mb-3 border border-primary">
          <div class="d-flex align-items-center justify-content-between p-3">
            <div class="d-flex align-items-center me-2">
              {% if resultados.azul.equipo %}
                {% if resultados.azul.equipo.logo %}
                  <img src="{{ MEDIA_URL }}{{ resultados.azul.equipo.logo }}" alt="{{ resultados.azul.equipo.nombre }}"
                      class="img-fluid rounded-start" style="height: 60px;">
                {% else %}
                  <span class="text-white fw-bold">{{ resultados.azul.equipo.nombre }}</span>
                {% endif %}
              {% endif %}
            </div>
            <div class="text-center flex-grow-1">
              <div class="small">{{ serie.dia|date:"d M Y" }}</div>
              <div class="fs-4 fw-bold">
                {{ resultados.azul.victorias }} : {{ resultados.rojo.victorias }}
              </div>
            </div>
            <div class="d-flex align-items-center ms-2">
              {% if resultados.rojo.equipo %}
                {% if resultados.rojo.equipo.logo %}
                  <img src="{{ MEDIA_URL }}{{ resultados.rojo.equipo.logo }}" alt="{{ resultados.rojo.equipo.nombre }}"
                      class="img-fluid rounded-end" style="height: 60px;">
                {% else %}
                  <span class="text-white fw-bold">{{ resultados.rojo.equipo.nombre }}</span>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
        {% endwith %}
        {% endfor %}
      </div>
    </div>

    <!-- Clasificación -->
    <div class="col-12 col-md-6">
      <h2>Clasificación del Split - {{ ultimo_split.year }} {{ ultimo_split.split_type|capfirst }}</h2>
      <div id="clasificacion-container" class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-dark table-hover table-bordered align-middle">
          <thead class="table-primary text-dark">
            <tr>
              <th>Equipo</th>
              <th>Victorias</th>
              <th>Derrotas</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in clasificacion %}
            <tr>
              <td>
                {% if entry.equipo.logo %}
                <img src="{{ MEDIA_URL }}{{ entry.equipo.logo }}" alt="{{ entry.equipo.nombre }}" class="me-2" style="height: 30px;">
                {% endif %}
                {{ entry.equipo.nombre }}
              </td>
              <td>{{ entry.series_ganadas }}</td>
              <td>{{ entry.series_perdidas }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FILA 2 -->
  <div class="row g-4">
    <!-- Top 10 Jugadores -->
    <div class="col-12 col-md-6">
      <h2>Top 10 Jugadores por KDA - {{ ultimo_split.year }} {{ ultimo_split.split_type|capfirst }}</h2>
      <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table id="top-jugadores-table" class="table table-dark table-bordered align-middle">
          <thead class="table-primary text-dark">
            <tr>
              <th>Jugador</th>
              <th>Equipo</th>
              <th>Posición</th>
              <th>KDA</th>
              <th>Kills</th>
              <th>Deaths</th>
              <th>Assists</th>
            </tr>
          </thead>
          <tbody>
            {% for jugador in top_jugadores %}
            <tr>
              <td>{{ jugador.jugador__nombre }}</td>
              <td>{{ jugador.jugador__equipo__nombre }}</td>
              <td>{{ jugador.position }}</td>
              <td>{{ jugador.kda|floatformat:2 }}</td>
              <td>{{ jugador.total_kills }}</td>
              <td>{{ jugador.total_deaths }}</td>
              <td>{{ jugador.total_assists }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top 10 Campeones más Jugados -->
    <div class="col-12 col-md-6">
      <h2>Campeones más Jugados - {{ ultimo_split.year }} {{ ultimo_split.split_type|capfirst }}</h2>
      <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table id="campeones-table" class="table table-dark table-hover table-bordered align-middle">
          <thead class="table-primary text-dark">
            <tr>
              <th>Campeón</th>
              <th>Veces Jugado</th>
              <th>Pick Rate (%)</th>
              <th>Veces Baneado</th>
              <th>Ban Rate (%)</th>
            </tr>
          </thead>
          <tbody>
            {% for c in campeones_stats %}
            <tr>
              <td class="d-flex align-items-center">
                {% if c.imagen %}
                <img src="{{ MEDIA_URL }}{{ c.imagen }}" alt="{{ c.nombre }}" style="height: 40px; margin-right: 10px;">
                {% endif %}
                {{ c.nombre }}
              </td>
              <td>{{ c.num_picks }}</td>
              <td>{{ c.pick_rate|floatformat:2 }}%</td>
              <td>{{ c.num_bans }}</td>
              <td>{{ c.ban_rate|floatformat:2 }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function ajustarAlturaSeries() {
    const clasificacion = document.getElementById('clasificacion-container');
    const series = document.getElementById('series-container');

    if (clasificacion && series) {
      const altura = clasificacion.offsetHeight;
      series.style.maxHeight = altura + 'px';
      series.style.overflowY = 'auto';  // habilita scroll si es necesario
    }
  }

  function igualarAlturaFilas() {
    const filasJugadores = document.querySelectorAll('#top-jugadores-table tbody tr');
    const filasCampeones = document.querySelectorAll('#campeones-table tbody tr');

    const numFilas = Math.min(filasJugadores.length, filasCampeones.length);

    for (let i = 0; i < numFilas; i++) {
      filasJugadores[i].style.height = 'auto';
      filasCampeones[i].style.height = 'auto';

      const alturaJug = filasJugadores[i].offsetHeight;
      const alturaCam = filasCampeones[i].offsetHeight;
      const maxAltura = Math.max(alturaJug, alturaCam);

      filasJugadores[i].style.height = maxAltura + 'px';
      filasCampeones[i].style.height = maxAltura + 'px';
    }
  }

  window.addEventListener('load', () => {
    ajustarAlturaSeries();
    igualarAlturaFilas();
  });

  window.addEventListener('resize', () => {
    ajustarAlturaSeries();
    igualarAlturaFilas();
  });
</script>
{% endblock %}
